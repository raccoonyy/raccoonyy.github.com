<!DOCTYPE html>
<html lang="ko">
<head>

    <title>(엑셀만큼 쉬운) Django Annotation/Aggregation</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=841d0b82a7" />

    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://raccoonyy.github.io/django-annotate-and-aggregate-like-as-excel/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="raccoony&#x27;s cave" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="(엑셀만큼 쉬운) Django Annotation/Aggregation" />
    <meta property="og:description" content="Django ORM을 강력하게 만들어주는 기능 중 하나는 바로 애너테이션(annotate)과 애그리게이션(aggregate)입니다. 이 두 기능이 명쾌하게 와닿지 않아서 사용하지 못하다가, 엑셀에 빗대어 이해해보니 제게는 도움이 되어서 해당 내용을 공유합니다.  시작하기 전에 표기법: 이건 Django 메서드 이름, 이건 필드나 값 을 나타냅니다. 메서드의 링크는 Django 공식 문서로 연결됩니다 모델" />
    <meta property="og:url" content="https://raccoonyy.github.io/django-annotate-and-aggregate-like-as-excel/" />
    <meta property="og:image" content="https://raccoonyy.github.io/content/images/2016/05/excel.jpg" />
    <meta property="article:published_time" content="2016-05-24T23:59:00.000Z" />
    <meta property="article:modified_time" content="2017-08-03T10:24:57.000Z" />
    <meta property="article:tag" content="Django" />
    <meta property="article:tag" content="annotate" />
    <meta property="article:tag" content="aggregate" />
    <meta property="article:tag" content="ORM" />
    <meta property="article:tag" content="애너테이션" />
    <meta property="article:tag" content="애그리게이션" />
    <meta property="article:tag" content="조건적 애너테이션" />
    
    <meta property="article:publisher" content="https://www.facebook.com/raccoonyy" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="(엑셀만큼 쉬운) Django Annotation/Aggregation" />
    <meta name="twitter:description" content="Django ORM을 강력하게 만들어주는 기능 중 하나는 바로 애너테이션(annotate)과 애그리게이션(aggregate)입니다. 이 두 기능이 명쾌하게 와닿지 않아서 사용하지 못하다가, 엑셀에 빗대어 이해해보니 제게는 도움이 되어서 해당 내용을 공유합니다.  시작하기 전에 표기법: 이건 Django 메서드 이름, 이건 필드나 값 을 나타냅니다. 메서드의 링크는 Django 공식 문서로 연결됩니다 모델" />
    <meta name="twitter:url" content="https://raccoonyy.github.io/django-annotate-and-aggregate-like-as-excel/" />
    <meta name="twitter:image" content="https://raccoonyy.github.io/content/images/2016/05/excel.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="raccoony" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Django, annotate, aggregate, ORM, 애너테이션, 애그리게이션, 조건적 애너테이션" />
    <meta name="twitter:site" content="@raccoonyy" />
    <meta property="og:image:width" content="459" />
    <meta property="og:image:height" content="300" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "raccoony&#x27;s cave",
        "url": "https://raccoonyy.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://raccoonyy.github.io/favicon.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "raccoony",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/357fbea2b22fc72b351478c2c3a1ab23?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://raccoonyy.github.io/author/raccoony/",
        "sameAs": []
    },
    "headline": "(엑셀만큼 쉬운) Django Annotation/Aggregation",
    "url": "https://raccoonyy.github.io/django-annotate-and-aggregate-like-as-excel/",
    "datePublished": "2016-05-24T23:59:00.000Z",
    "dateModified": "2017-08-03T10:24:57.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://raccoonyy.github.io/content/images/2016/05/excel.jpg",
        "width": 459,
        "height": 300
    },
    "keywords": "Django, annotate, aggregate, ORM, 애너테이션, 애그리게이션, 조건적 애너테이션",
    "description": "Django ORM을 강력하게 만들어주는 기능 중 하나는 바로 애너테이션(annotate)과 애그리게이션(aggregate)입니다. 이 두\n기능이 명쾌하게 와닿지 않아서 사용하지 못하다가, 엑셀에 빗대어 이해해보니 제게는 도움이 되어서 해당 내용을 공유합니다.\n\n시작하기 전에\n * 표기법: 이건 Django 메서드 이름, 이건 필드나 값 을 나타냅니다.\n * 메서드의 링크는 Django 공식 문서로 연결됩니다\n\n모델 구성\n다음과 같은 제품을 판매하는 온라인 쇼핑몰을 만든다고 합시다. (원래는 제품별 id도 있겠지만, 설명을 간단히 하기 위해 생략하겠습니다.)\n\n\n\n이를 Django 모델로 구현해보면 다음과 같을 겁니다.\n\nclass Product(models.Model):\n    name &#x3D; models.CharField(&#x27;이름&#x27;, max_length&#x3D;150, unique&#x3D;True)\n    price &#x3D; models.IntegerField(&#x27;가격&#x27;)\n\n\n이제, 이 제품들이 팔린 내역",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://raccoonyy.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.1" />
    <link rel="alternate" type="application/rss+xml" title="raccoony&#x27;s cave" href="https://raccoonyy.github.io/rss/" />
    <script defer src="https://unpkg.com/@tryghost/portal@~1.0.0/umd/portal.min.js" data-ghost="https://raccoonyy.github.io/"></script><style> .gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <meta name="google-site-verification" content="HbTOu4bsFHuaiGTyAv017aq7Z_-DyKGG4Zdf6GAf3Eg" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-tomorrow.min.css" />
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2370280605121686",
    enable_page_level_ads: true
  });
</script>
<script>var disqus = 'raccoonyscave'</script>
<style>:root {--ghost-accent-color: #FF1A75;}</style>

</head>
<body class="post-template tag-django tag-annotate tag-aggregate tag-orm tag-aeneoteisyeon tag-aegeurigeisyeon tag-jogeonjeog-aeneoteisyeon">
<div class="viewport">

    <header id="gh-head" class="gh-head has-cover">
        <nav class="gh-head-inner inner gh-container">

            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://raccoonyy.github.io">
                        raccoony&#x27;s cave
                </a>
                <a class="gh-burger" role="button">
                    <div class="gh-burger-box">
                        <div class="gh-burger-inner"></div>
                    </div>
                </a>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="http://raccoonyy.github.io/">Home</a></li>
    <li class="nav-about-me"><a href="https://raccoonyy.github.io/about-me/">About Me</a></li>
    <li class="nav-django"><a href="https://raccoonyy.github.io/tag/django/">Django</a></li>
    <li class="nav-python"><a href="https://raccoonyy.github.io/tag/python/">Python</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                        <a class="gh-social-facebook" href="https://www.facebook.com/raccoonyy" title="Facebook" target="_blank" rel="noopener"><svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 0c8.837 0 16 7.163 16 16s-7.163 16-16 16S0 24.837 0 16 7.163 0 16 0zm5.204 4.911h-3.546c-2.103 0-4.443.885-4.443 3.934.01 1.062 0 2.08 0 3.225h-2.433v3.872h2.509v11.147h4.61v-11.22h3.042l.275-3.81h-3.397s.007-1.695 0-2.187c0-1.205 1.253-1.136 1.329-1.136h2.054V4.911z" /></svg></a>
                        <a class="gh-social-twitter" href="https://twitter.com/raccoonyy" title="Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
                </div>

                    <a class="gh-head-button" href="#/portal">Subscribe</a>
            </div>
        </nav>
    </header>

    <main>
        



<article class="article post tag-django tag-annotate tag-aggregate tag-orm tag-aeneoteisyeon tag-aegeurigeisyeon tag-jogeonjeog-aeneoteisyeon">

    <header class="article-header gh-canvas">

        <section class="article-tag">
            <a href="https://raccoonyy.github.io/tag/django/">Django</a>
        </section>

        <h1 class="article-title">(엑셀만큼 쉬운) Django Annotation/Aggregation</h1>


        <div class="article-byline">
            <section class="article-byline-content">
                <ul class="author-list">
                    <li class="author-list-item">
                        <a href="/author/raccoony/" class="author-avatar">
                            <img class="author-profile-image" src="//www.gravatar.com/avatar/357fbea2b22fc72b351478c2c3a1ab23?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="raccoony" />
                        </a>
                    </li>
                </ul>
                <div class="article-byline-meta">
                    <h4 class="author-name"><a href="/author/raccoony/">raccoony</a></h4>
                    <div class="byline-meta-content">
                        <time class="byline-meta-date" datetime="2016-05-25">2016년 5월 25일</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 16 min read</span>
                    </div>
                </div>
            </section>
        </div>

        <figure class="article-image">
            <img
                srcset="/content/images/size/w300/2016/05/excel.jpg 300w,
                        /content/images/size/w600/2016/05/excel.jpg 600w,
                        /content/images/size/w1000/2016/05/excel.jpg 1000w,
                        /content/images/size/w2000/2016/05/excel.jpg 2000w"
                sizes="(min-width: 1400px) 1400px, 92vw"
                src="/content/images/size/w2000/2016/05/excel.jpg"
                alt="(엑셀만큼 쉬운) Django Annotation/Aggregation"
            />
        </figure>
    </header>

    <section class="gh-content gh-canvas">
        <!--kg-card-begin: markdown--><p>Django ORM을 강력하게 만들어주는 기능 중 하나는 바로 애너테이션(<code>annotate</code>)과 애그리게이션(<code>aggregate</code>)입니다. 이 두 기능이 명쾌하게 와닿지 않아서 사용하지 못하다가, 엑셀에 빗대어 이해해보니 제게는 도움이 되어서 해당 내용을 공유합니다.</p>
<h4 id="">시작하기 전에</h4>
<ul>
<li>표기법: <code>이건 Django 메서드 이름</code>, <em>이건 필드나 값</em> 을 나타냅니다.</li>
<li>메서드의 링크는 Django 공식 문서로 연결됩니다</li>
</ul>
<h2 id="">모델 구성</h2>
<p>다음과 같은 제품을 판매하는 온라인 쇼핑몰을 만든다고 합시다. (원래는 제품별 id도 있겠지만, 설명을 간단히 하기 위해 생략하겠습니다.)</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-19-09-21-34-1.png" alt="" loading="lazy"></p>
<p>이를 Django 모델로 구현해보면 다음과 같을 겁니다.</p>
<pre><code class="language-python">class Product(models.Model):
    name = models.CharField('이름', max_length=150, unique=True)
    price = models.IntegerField('가격')
</code></pre>
<p>이제, 이 제품들이 팔린 내역이 다음과 같다고 해보죠.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-21-13-15-45.png" alt="" loading="lazy"></p>
<p>이러한 판매 내역을 모델로 구현하면 다음과 같겠고요.</p>
<pre><code class="language-python">class OrderLog(models.Model):
    product = models.ForeignKey('Product')
    created = models.DateTimeField(u'판매일')
</code></pre>
<p>엑셀 화면과 코드를 비교해 보면 엑셀의 컬럼 하나가 Django의 필드 하나와 대응됨을 발견할 수 있습니다.</p>
<p>데이터베이스를 구성했으니, <a href="https://gist.github.com/raccoonyy/b1aa0c36bfcf2f207737b72efadcc0a4">이 코드</a>를 실행해서 실습용 데이터를 만들어주세요.</p>
<h2 id="">총 판매액 구하기</h2>
<p>판매 내역을 보면 물품 이름만 있고 가격이 적혀 있지 않습니다. 엑셀에서 작업할 때라면 <strong>1.</strong> 제품별 가격을 옆에 적어두고, <strong>2.</strong> 그 값을 모두 더해서 총 판매액을 알 수 있겠죠. 이 과정을 Django로 따라해 봅시다.</p>
<h4 id="1values">1. 제품별 가격 참조하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.values">values</a>)</h4>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서 제품별 가격을 적었다면 다음과 같은 화면이 되겠죠. (실제로는 일일이 찾지 않고 제품 이름으로 참조하여 판매 가격 컬럼을 자동으로 채을 겁니다.)</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-21-13-17-57.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>이를 Django에서 구현하려면 <code>values</code> 메서드를 사용하면 됩니다.</p>
<pre><code class="language-python">order_qs = OrderLog.objects.values(
    'created', 'product__name', 'product__price'
)
</code></pre>
<p><code>order_queryset</code>의 내용을 출력해보면 엑셀과 같음을 알 수 있습니다.</p>
<pre><code class="language-python">&gt;&gt;&gt; for order in order_qs:
...     print(order)
...
{'product__price': 9900, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'product__name': 'ABC Activity'}
{'product__price': 8200, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'product__name': '동물동요'}

# (중략)

{'product__price': 9900, 'created': datetime.datetime(2016, 4, 3, 0, 0), 'product__name': 'ABC Activity'}
</code></pre>
<p>밑줄 두 개가 붙은 모습이 보기에 좋지 않고, 타이핑하기도 귀찮으니까 짧은 이름으로 바꿔주겠습니다.</p>
<pre><code class="language-python"># 앞의 쿼리를 재작성
order_qs = OrderLog.objects.annotate(
    name=F('product__name'), 
    price=F('product__price')
).values(
    'created', 'name', 'price'
)

# 내용을 보면,
{'price': 9900, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'name': 'ABC Activity'}
{'price': 8200, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'name': '동물동요'}
{'price': 38400, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'name': '사운드북 패키지'}
...
# (하략)
</code></pre>
<blockquote>
<p>이후 등장할 코드에는 Django ORM 메서드가 많이 나오는데요. 필요한 메서드를 미리 불러두시면 좋습니다.</p>
</blockquote>
<pre><code class="language-python">from django.db.models import F, Sum, Count, Case, When
</code></pre>
<p>방금 사용한 애너테이션(<code>annotate</code>)은 필드 하나를 만들고 거기에 '어떤 내용'을 채웁니다. 엑셀에서 컬럼 하나를 만드는 것과 같다고 생각하면 됩니다.</p>
<p>'내용'에는 <strong>1.</strong> (방금 했듯이) 다른 필드의 값을 그대로 복사하거나, <strong>2.</strong> (이후에 나오겠지만) 다른 필드의 값들을 조합한 값을 넣을 수 있습니다.</p>
<blockquote>
<p>annotate의 사전적 의미는 '주석을 달다'인데요. Django에서는 주석 대신 '필드'를 추가한다고 생각하시면 되겠습니다. (엑셀이라면 컬럼을 추가하는 셈이겠고요.)</p>
</blockquote>
<h4 id="2aggregatesum">2. 제품 가격 모두 더해서 총 판매액 구하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#aggregate">aggregate</a>, <a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#sum">Sum</a>)</h4>
<p>그럼 이제 <em>price</em>의 값을 모두 합하여 총 판매액을 구해야겠죠.</p>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서는 수식을 사용하여 해당 필드 전체를 더해줍니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-21-15-55-55.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>Django에서 쿼리셋의 특정 필드를 모두 더할 때는 애그리게이션(<code>aggregate</code>) 메서드를 사용합니다.</p>
<pre><code class="language-python"># 앞의 코드에서 이어집니다.
&gt;&gt;&gt; order_qs.aggregate(total_price=Sum('price'))
{'total_price': 262200}
</code></pre>
<blockquote>
<p>aggregate의 사전적 의미는 '합계', '종합'입니다. Django에서는 필드 전체의 합이나 평균, 개수 등을 계산할 때 사용하면 됩니다. (엑셀에서는 한 컬럼 전체의 합이나 평균, 개수를 계산한다고 보면 되겠고요.)</p>
</blockquote>
<h2 id="valuesannotatesum">일별 판매액 구하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.values">values</a>, <a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#annotate">annotate</a>, <a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#sum">Sum</a>)</h2>
<p>총 판매액이 아닌 일별 판매액을 구할 땐 어떻게 할까요?</p>
<h6 id="">엑셀 버전</h6>
<p>엑셀이라면 피벗 테이블을 만들텐데요. 피벗 테이블에 익숙하지 않은 분을 위해 간단히 설명을 하자면, 기준(pivot)을 정하고 이 기준에 따라 값을 묶는 기능이라고 생각하시면 됩니다. (자세한 사용 방법은 <a href="https://support.office.com/ko-kr/article/%ED%94%BC%EB%B2%97-%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%84-%EB%A7%8C%EB%93%A4%EC%96%B4-%EC%9B%8C%ED%81%AC%EC%8B%9C%ED%8A%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%B6%84%EC%84%9D-a9a84538-bfe9-40a9-a8e9-f99134456576">엑셀 2013 도움말</a>을 참고하세요.)</p>
<p>예를 들어, 날짜를 행의 기준으로 정하고 가격을 묶으면(=합계), 다음과 같이 일별 판매액을 알 수 있겠죠.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-19-10-11-05.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>Django에서 뭔가를 기준으로 값들을 묶고 싶다면 <code>values</code>와 <code>annotate</code>를 사용하면 됩니다. 여기서는 날짜(<em>created</em>)가 기준이 되고, 날짜별로 묶고 싶은 값은 가격(<em>price</em>)입니다. 묶은 값들은 모두 더해서 <em>daily_total</em> 필드에 넣어주었습니다.</p>
<p><strong><code>values</code> 메서드 이전에 <code>annotate</code>로 추가했던 필드는, <code>values</code> 메서드 이후에 나오는 <code>annotate</code> 메서드에서 참조할 수 없습니다. 아쉽지만 여기서는 <em>product__price</em>를 그대로 적어주어야 합니다.</strong></p>
<pre><code class="language-python">daily_list = order_qs.values(
    'created'
).annotate(
    daily_total=Sum('product__price')
)

# 내용을 확인해보면,
&gt;&gt;&gt; for data in daily_data_list:
...     print(data)
...
{'daily_total': 113000, 'created': datetime.datetime(2016, 4, 1, 0, 0)}
{'daily_total': 84500, 'created': datetime.datetime(2016, 4, 2, 0, 0)} 
{'daily_total': 64700, 'created': datetime.datetime(2016, 4, 3, 0, 0)}
</code></pre>
<h2 id="valuesannotatecount">날짜별+제품별 판매 개수 구하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.values">values</a>, <a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#annotate">annotate</a>, <a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#count">Count</a>)</h2>
<p>조금 더 들어가 봅시다. 이제는 날짜별로 각 제품이 몇 개씩 팔렸는지 알고 싶습니다.</p>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서는 역시나 피벗 테이블을 사용하겠죠. 아까의 피벗 테이블에서 <strong>1.</strong> 열 기준으로 행을 추가하고, <strong>2.</strong> 값으로는 레코드의 개수를 선택하면 아래와 같이 일별/제품별 판매 개수를 알 수 있습니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-21-13-11-33.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>이를 Django에 옮겨보죠. <code>values</code>에 넣을 기준 필드는 <em>created</em>와 <em>name</em>이 되겠고요. <code>annotate</code>에서는 레코드 개수를 세기 위해 <code>Count</code> 메서드를 사용했습니다. <em>count</em> 필드를 만들어서 일별+제품별 판매 개수를 넣어주었고요.</p>
<pre><code class="language-python">daily_count = order_qs.values(
    'created', 'name'
).annotate(
    count=Count('name')
)

# 내용을 확인해보면,
&gt;&gt;&gt; for data in daily_count:
...     print(data)
...
{'count': 2, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'name': 'ABC Activity'}
{'count': 2, 'created': datetime.datetime(2016, 4, 1, 0, 0), 'name': '동물동요'}

# (중략)

{'count': 1, 'created': datetime.datetime(2016, 4, 3, 0, 0), 'name': '사운드북 패키지'}
</code></pre>
<h2 id="filter">특정 제품의 날짜별 판매 개수 구하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#filter">filter</a>)</h2>
<p>전체 제품이 아닌 관심 있는 제품의 날짜별 판매 개수를 알고 싶을 땐 어떻게 할까요?</p>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서는 피벗 테이블에 필터를 추가하면 됩니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-23-17-36-52.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>Django에서도 필터(<code>filter</code>)를 추가하면 됩니다. <code>filter</code> 외의 부분은 바로 앞의 코드와 동일합니다.</p>
<pre><code class="language-python">sound_book_daily_count = order_qs.filter(
    name='ABC Activity'
).values(
    'created', 'name'
).annotate(
    count=Count('product')
)

# 내용을 확인해보면,
{'name': 'ABC Activity', 'count': 2, 'created': datetime.datetime(2016, 4, 1, 0, 0}
{'name': 'ABC Activity', 'count': 3, 'created': datetime.datetime(2016, 4, 2, 0, 0}
{'name': 'ABC Activity', 'count': `, 'created': datetime.datetime(2016, 4, 3, 0, 0}
</code></pre>
<h2 id="">(심화) 결제 취소 발생!</h2>
<p>이제 진짜 애너테이션과 애그리게이션이 유용한 사례를 살펴봅시다. 쇼핑몰에서는 판매 내역이 취소되기도 하죠. 결제가 취소되었을 때는 취소 로그를 남겨야 합니다. 여기서는 최대한 간단히 설명하기 위해 판매 내역에 <em>결제 취소(is_cancel)</em> 필드를 추가하고, 결제 취소 내역인 경우에는 해당 필드를 <em>True</em>로 설정하겠습니다.</p>
<h4 id="">엑셀 버전</h4>
<p>엑셀에서는 다음과 같은 열이 추가됩니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-19-12-58-10.png" alt="" loading="lazy"></p>
<h4 id="django">Django 버전</h4>
<p>OrderLog 모델은 다음과 같이 수정하겠습니다. (원래는 취소된 내역 자체도 참조해야 하지만, 여기서는 설명을 간단히 하고자 생략했습니다.)</p>
<pre><code class="language-python"># OrderLog 모델 수정
class OrderLog(models.Model):
    product = models.ForeignKey('Product')
    created = models.DateTimeField(u'판매일', auto_now_add=True)
    is_cancel = models.BooleanField(u'결제 취소인지', default=False)  # 추가된 필드
</code></pre>
<blockquote>
<p>여기서는 설명하지 않겠지만, 모델을 변경했다면 데이터베이스 마이그레이션 과정을 거쳐야만 합니다.</p>
</blockquote>
<p>그리고 결제 취소 내역을 추가합니다.</p>
<pre><code class="language-python">abc = Product.objects.get(name='ABC Activity')
may3 = datetime(2016, 4, 3)
OrderLog.objects.create(created=may3, product=abc, is_cancel=True)
</code></pre>
<h2 id="">(결제 취소 버전) 총 판매액 수정</h2>
<p>지금 시점에 총 판매액을 다시 계산해보면 맨 마지막에 추가한 결제 취소 내역 때문에 다음과 같이 총 판매액이 잘못 계산됩니다.</p>
<pre><code class="language-python">&gt;&gt;&gt; order_qs.aggregate(total_price=Sum('price'))
{'total_price': 272100}
</code></pre>
<p>일견, <code>exclude</code>를 추가해서 결제 취소 내역을 제외시키고 계산을 하려 할지도 모르겠습니다. 그래도 여전히 판매액이 틀립니다.</p>
<pre><code class="language-python">order_qs.exclude(
    is_cancel=True
).aggregate(
    total_price=Sum('price')
)

# 내용을 확인해보면,
{'total_price': 262200}
</code></pre>
<p>왜냐하면 <strong>총 판매액 = 순수 판매 금액 - 취소 금액</strong>이기 때문입니다. 바로 앞의 쿼리는 취소 금액을 계산하지 않습니다. (애초에 결제 취소 내역의 판매 금액을 음수로 저장하는 방법도 있지만, 여기서는 설명을 위해 그렇게 하지 않았습니다.)</p>
<p>그럼 이제 판매 금액과 취소 금액, 총 판매액을 계산해보겠습니다.</p>
<p>엑셀에서라면 <strong>1.</strong> 판매 금액 컬럼과 취소 금액 컬럼을 추가하고, 결제 취소 필드의 내용에 따라 각 컬럼에 가격을 넣은 다음, <strong>2.</strong> 판매 금액의 합에서 취소 금액의 합을 빼주면 됩니다.</p>
<h4 id="1">1. 결제 취소 필드에 따라 판매 금액, 취소 금액 필드 추가하기(<a href="https://docs.djangoproject.com/en/1.9/ref/models/conditional-expressions/">조건적 애너테이션</a>)</h4>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서의 모습을 보면 다음과 같습니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-19-13-19-10.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>이를 Django에 구현하기는 조금 까다롭습니다. 결제 취소라는 조건이 생긴 탓인데요. Django 1.8에 추가된 조건적 애너테이션을 사용하면 이 문제를 해결할 수 있습니다. 조건적 애너테이션이란, 말 그대로 특정 조건에 따라 애너테이션을 붙일 수 있는 기능입니다.</p>
<pre><code class="language-python">order_list_2 = order_qs.annotate(
    sales_price=Case(
        When(
            is_cancel=False,  # 결제 취소가 아닌 경우
            then=F('price')
        ),
        default=0
    ),
    cancel_price=Case(
        When(
            is_cancel=True,   # 결제 취소인 경우
            then=F('price')
        ),
        default=0
    )
)
</code></pre>
<p>이렇게 하면 판매 내역인 경우 <em>sales_price</em> 필드에 <em>price</em> 값이 들어가고, 결제 취소 내역인 경우엔 <em>cancel_price</em> 필드에 <em>price</em> 값이 들어갑니다. (<code>default=0</code>이므로 해당하지 않는 필드에는 0이 들어갑니다.)</p>
<p>결과를 확인해보죠.</p>
<pre><code class="language-python">&gt;&gt;&gt; for data in order_list_2:
...     print(data)
...
{'cancel_price': 0, 'name': 'ABC Activity', 'sales_price': 9900, 'price': 9900, 'created': datetime.datetime(2016, 4, 1, 0, 0)}
{'cancel_price': 0, 'name': '동물동요', 'sales_price': 8200, 'price': 8200, 'created': datetime.datetime(2016, 4, 1, 0, 0)}

# (중략)

{'cancel_price': 9900, 'name': 'ABC Activity', 'sales_price': 0, 'price': 9900, 'created': datetime.datetime(2016, 4, 3, 0, 0)}
</code></pre>
<h4 id="2">2. 판매 금액의 합 - 취소 금액의 합 = 총 판매액</h4>
<p>이제 판매 금액의 합에서 취소 금액의 합을 빼 봅시다.</p>
<h6 id="">엑셀 버전</h6>
<p>엑셀에서라면 다음과 같이 소계가 추가될 겁니다.</p>
<p><img src="/content/images/2016/05/Screenshot-2016-05-20-14-01-41.png" alt="" loading="lazy"></p>
<h6 id="django">Django 버전</h6>
<p>이를 Django로 옮기면 다음과 같습니다.</p>
<pre><code class="language-python"># 위에서 이어집니다.
result = order_list_2.aggregate(
    total_price=Sum('sales_price')-Sum('cancel_price')
)
</code></pre>
<p>판매 금액의 합(<code>Sum('sales_price')</code>)에서 취소 금액의 합(<code>Sum('cancel_price')</code>)을 빼서, <em>total_price</em> 필드에 넣었습니다. 특정 필드 전체에 대한 연산이므로 애그리게이션(<code>aggregate</code>)을 사용했습니다.</p>
<pre><code class="language-python"># 내용을 확인해보면,
&gt;&gt;&gt; result
{'total_price': 252300}
</code></pre>
<h2 id="">(결제 취소 버전) 특정 제품의 날짜별 판매 개수 계산하기</h2>
<p>특정 제품의 날짜별 판매 개수에도 역시 결제 취소 내역이라는 장애물이 생겼습니다. 총 판매액에서처럼 조건적 애너테이션을 사용하면 계산할 수 있겠는데요. 일단 결제 취소 내역이 발생하기 전의 코드를 다시 살펴보죠.</p>
<pre><code class="language-python"># 결제 취소가 생기기 전 버전
sound_book_daily_count = order_qs.filter(
    name='사운드북 패키지'
).values(
    'created', 'name'
).annotate(
    count=Count('product')
)
</code></pre>
<p>애너테이션(<code>annotate</code>) 부분을 수정하면 될 것 같습니다.</p>
<pre><code class="language-python">sound_book_daily_count = order_qs.filter(
    name='ABC Activity'
).values(
    'created', 'name'
).annotate(
    count=Sum(
        Case(
            When(
                is_cancel=False, then=1, 
            ),
            When(
                is_cancel=True, then=-1
            ),
            output_field=IntegerField(),
            default=0
        )
    )
)
</code></pre>
<p>총 판매액 쿼리와는 살짝 달라진 모습을 알 수 있습니다. 순수 판매 내역인 경우엔(<code>is_cancel=False</code>) 1을 넣고(<code>then=1</code>), 결제 취소 내역인 경우엔(<code>is_cancel=True</code>) -1을 넣습니다(<code>then=-1</code>). 그리고 이 값들을 모두 합해서 <em>count</em> 필드에 넣었습니다.</p>
<p>결과는 다음과 같습니다.</p>
<pre><code class="language-python">{'name': 'ABC Activity', 'count': 2, 'created': datetime.datetime(2016, 4, 1, 0, 0}
{'name': 'ABC Activity', 'count': 3, 'created': datetime.datetime(2016, 4, 2, 0, 0}
{'name': 'ABC Activity', 'count': 0, 'created': datetime.datetime(2016, 4, 3, 0, 0}
</code></pre>
<p>4월 3일의 판매 개수에서 결제 취소 내역이 제대로 반영되었음을 알 수 있습니다.</p>
<h2 id="">(부록) 반복되는 애너테이션 구문은 저장해서 사용하기</h2>
<p>조건적 애너테이션 구문은 항상 길어지기 마련이라 유지보수하기가 어려워지는 단점이 있는데요. 만약 여러 군데서 같은 구문을 사용한다면 다음과 같이 중복을 없앨 수 있습니다.</p>
<p>먼저 조건적 애너테이션 구문을 저장해놓고,</p>
<pre><code class="language-python">REAL_COUNT = Sum(
    Case(
        When(
            is_cancel=False, then=1, 
        ),
        When(
            is_cancel=True, then=-1
        ),
        output_field=FloatField(),
        default=0
    )
)
</code></pre>
<p>저장한 애너테이션 구문은 다음과 같이 사용합니다.</p>
<pre><code class="language-python">sound_book_daily_count = order_qs.filter(
    name='ABC Activity'
).values(
    'created', 'name'
).annotate(
    count=REAL_COUNT
)
</code></pre>
<h2 id="">요약</h2>
<p>지금까지 Django의 애너테이션과 애그리게이션에 대해 알아보았습니다. 요약하면 다음과 같습니다.</p>
<ol start="0">
<li>Django 모델의 필드는 엑셀의 컬럼에 대입된다고 생각합시다.</li>
<li>애너테이션(<code>annotate</code>)은 엑셀에서 계산용 컬럼을 하나 추가하는 것과 같습니다.</li>
<li>애그리게이션(<code>aggregate</code>)은 엑셀에서 특정 컬럼 전체를 대상으로 계산하는 것과 같습니다. (합, 평균, 개수 등)</li>
</ol>
<p>이 정도만 이해하신다면, Django의 annotate와 aggregate 메서드를 좀더 친근하게 사용하실 수 있을 겁니다. :)</p>
<h2 id="">참고할 만한 링크</h2>
<ul>
<li><a href="https://docs.djangoproject.com/en/1.9/topics/db/aggregation/">Django 공식 문서의 애너테이션 가이드(영문)</a></li>
<li><a href="https://docs.djangoproject.com/en/1.9/ref/models/conditional-expressions/">Django 공식 문서의 조건적 애너테이션 가이드(영문)</a></li>
<li><a href="http://agiliq.com/blog/2009/08/django-aggregation-tutorial/">Django의 애너테이션과 애그리게이션 튜토리얼(블로그/영문)</a></li>
<li><a href="http://raccoonyy.github.io/conditional-annotate-with-django-query/">django 쿼리에 조건적 annotate 붙이기(블로그/한글)</a></li>
<li><a href="http://jerrywohlgemuth.com/detail/conditional-aggregations-with-django/">조건적 애너테이션(블로그/영문)</a></li>
<li><a href="https://splbio.wordpress.com/2013/10/28/some-nitty-gritty-django-orm-queries-multiple-group-by/">애너테이션 적용시 주의할 점(블로그/영문)</a></li>
</ul>
<!--kg-card-end: markdown-->
    </section>


</article>

<section class="footer-cta">
    <div class="inner">
        <h2>Sign up for more like this.</h2>
        <a class="footer-cta-button" href="#/portal">
            <div>Enter your email</div>
            <span>Subscribe</span>
        </a>
    </div>
</section>


<aside class="read-more-wrap">
    <div class="read-more inner">


                    
<article class="post-card post featured ">

    <a class="post-card-image-link" href="/docker-usages-for-dev-environment-setup/">
        <img class="post-card-image"
            srcset="/content/images/size/w300/2017/02/docker-usages-dev-environment-setup.png 300w,
                    /content/images/size/w600/2017/02/docker-usages-dev-environment-setup.png 600w,
                    /content/images/size/w1000/2017/02/docker-usages-dev-environment-setup.png 1000w,
                    /content/images/size/w2000/2017/02/docker-usages-dev-environment-setup.png 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="/content/images/size/w600/2017/02/docker-usages-dev-environment-setup.png"
            alt="Docker (Compose) 활용법 - 개발 환경 구성하기"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/docker-usages-for-dev-environment-setup/">
            <header class="post-card-header">
                <h2 class="post-card-title">Docker (Compose) 활용법 - 개발 환경 구성하기</h2>
            </header>
            <section class="post-card-excerpt">
                <p>인프런 강의 안내 이 글의 내용을 인프런 강의로 제작하였습니다. 아래 배너를 눌러주세요~  도커 쓸 땐 필수! 도커 컴포즈 - 인프런 | 강의도커를 실제 사용하려다보면 항상 등장하는 도커 컴포즈! 무엇이 좋은지, 어떻게 활용하는지를 실습과 함께 배울 수 있습니다., 도커 컴포즈, 기본부터 핵심까지!도커를 실제 사용하려다보면 항상 도커 컴포즈가 등장합니다.도커만으로도 힘겨웠는데 또</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/raccoony/" class="static-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/357fbea2b22fc72b351478c2c3a1ab23?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="raccoony" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/raccoony/">raccoony</a></span>
                <span class="post-card-byline-date"><time datetime="2021-03-26">2021년 3월 26일</time> <span class="bull">&bull;</span> 38 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="/geeks-who-invented-click-and-internet/">
        <img class="post-card-image"
            srcset="/content/images/size/w300/2018/03/click.jpg 300w,
                    /content/images/size/w600/2018/03/click.jpg 600w,
                    /content/images/size/w1000/2018/03/click.jpg 1000w,
                    /content/images/size/w2000/2018/03/click.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="/content/images/size/w600/2018/03/click.jpg"
            alt="[독후감] 클릭을 발명한 괴짜들"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/geeks-who-invented-click-and-internet/">
            <header class="post-card-header">
                <h2 class="post-card-title">[독후감] 클릭을 발명한 괴짜들</h2>
            </header>
            <section class="post-card-excerpt">
                <p>인터넷 기술이라고 하면 보통은 하드웨어와 소프트웨어를 떠올리기 쉬운데, 이 책은 기술 개발 이야기를 넘어 정보를 저장하고 찾는 기술 그리고 정보를 다루는 기계와 인간이 어떤 관계여야 하는지를 고민했던 사람들의 이야기를 다루고 있습니다. 이런 고민들이 자연스레 인터넷이라는 결과를 낳게 되는 과정이 정말 흥미로웠습니다.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/raccoony/" class="static-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/357fbea2b22fc72b351478c2c3a1ab23?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="raccoony" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/raccoony/">raccoony</a></span>
                <span class="post-card-byline-date"><time datetime="2018-03-28">2018년 3월 28일</time> <span class="bull">&bull;</span> 8 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="/diary-of-changing-job/">
        <img class="post-card-image"
            srcset="/content/images/size/w300/2018/02/man-adjusting-tie.jpg 300w,
                    /content/images/size/w600/2018/02/man-adjusting-tie.jpg 600w,
                    /content/images/size/w1000/2018/02/man-adjusting-tie.jpg 1000w,
                    /content/images/size/w2000/2018/02/man-adjusting-tie.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="/content/images/size/w600/2018/02/man-adjusting-tie.jpg"
            alt="이직 일기"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/diary-of-changing-job/">
            <header class="post-card-header">
                <h2 class="post-card-title">이직 일기</h2>
            </header>
            <section class="post-card-excerpt">
                <p>2018년 2월 12일부터 온디맨드코리아 한국 사무실로 출근합니다.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/raccoony/" class="static-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/357fbea2b22fc72b351478c2c3a1ab23?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="raccoony" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/raccoony/">raccoony</a></span>
                <span class="post-card-byline-date"><time datetime="2018-02-11">2018년 2월 11일</time> <span class="bull">&bull;</span> 18 min read</span>
            </div>
        </footer>

    </div>

</article>

    </div>
</aside>


    </main>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://raccoonyy.github.io">raccoony&#x27;s cave</a> &copy; 2021</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=841d0b82a7"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35614951-4', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>
